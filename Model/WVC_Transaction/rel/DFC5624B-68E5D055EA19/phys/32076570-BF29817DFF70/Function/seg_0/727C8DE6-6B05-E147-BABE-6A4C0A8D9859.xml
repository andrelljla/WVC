<?xml version = '1.0' encoding = 'UTF-8'?>
<FunctionOracle class="oracle.dbtools.crest.model.design.storage.oracle.FunctionOracle" name="GET_ACCOUNT_KEY" directorySegmentName="seg_0" id="727C8DE6-6B05-E147-BABE-6A4C0A8D9859">
<sourceConnName>wvc</sourceConnName>
<sourceObjSchema>WVC</sourceObjSchema>
<sourceObjName>GET_ACCOUNT_KEY</sourceObjName>
<createdBy>jandrews</createdBy>
<createdTime>2017-06-21 14:53:39 UTC</createdTime>
<ownerDesignName>WVC_Transaction</ownerDesignName>
<owner>201BFD0B-702B-582E-4A1E-3F0CC521546B</owner>
<source>CREATE OR REPLACE function WVC.GET_ACCOUNT_KEY &lt;br/&gt;( fileNumber in number &lt;br/&gt;, lastName in varchar2 &lt;br/&gt;, firstName in varchar2 &lt;br/&gt;, appointmentDateKey in number &lt;br/&gt;) return number as &lt;br/&gt;&lt;br/&gt;  account_key               number:= 0;&lt;br/&gt;  lastVisitDateKey          number:= 0;&lt;br/&gt;  oldAccountKey             number:= 0;&lt;br/&gt;/*  &lt;br/&gt;  cursor c_account is&lt;br/&gt;    select account_id from account where file_number = fileNumber&lt;br/&gt;      and UPPER(NVL(last_name,&apos;foo&apos;)) = UPPER(NVL(lastName,&apos;foo&apos;))&lt;br/&gt;      and UPPER(NVL(first_name,&apos;foo&apos;)) = UPPER(NVL(firstName,&apos;foo&apos;))&lt;br/&gt;      and appointmentDateKey between start_date_key and end_date_key;&lt;br/&gt;      &lt;br/&gt;  cursor c_fileNum is &lt;br/&gt;    select account_id from account where file_number = fileNumber;&lt;br/&gt;*/    &lt;br/&gt;  EndOfTimeDateKey    integer := 39991231;&lt;br/&gt;    &lt;br/&gt;begin&lt;br/&gt;&lt;br/&gt;  select account_id into account_key from account&lt;br/&gt;  where file_number = fileNumber&lt;br/&gt;    and upper(trim(nvl(last_name,&apos;NO_NAME&apos;))) = upper(trim(nvl(lastName, &apos;NO_NAME&apos;)))&lt;br/&gt;    and upper(trim(nvl(first_name, &apos;NO_NAME&apos;))) = upper(trim(nvl(firstName,&apos;NO_NAME&apos;)))&lt;br/&gt;    and appointmentDateKey between start_date_key and end_date_key;&lt;br/&gt;&lt;br/&gt;  return account_key;&lt;br/&gt;  &lt;br/&gt;exception &lt;br/&gt;  &lt;br/&gt;  when too_many_rows then&lt;br/&gt;    null;&lt;br/&gt;  &lt;br/&gt;  when no_data_found then&lt;br/&gt;    DBMS_OUTPUT.PUT_LINE(fileNumber||&apos;,&apos;||lastName||&apos;,&apos;||firstName||&apos;,&apos;||appointmentDateKey);&lt;br/&gt;&lt;br/&gt;    -- Determine if another (older) account uses the same file number&lt;br/&gt;    if file_number_assigned(fileNumber) then&lt;br/&gt;    &lt;br/&gt;      -- Get the account that is currently active for this fileNumber&lt;br/&gt;      -- shoudld be only 1, but wrapped in MAX to prevent too_many_rows if data corrupt&lt;br/&gt;      select max(account_id) into oldAccountKey from account where file_number = fileNumber and end_date_key = EndOfTimeDateKey;&lt;br/&gt;      &lt;br/&gt;      -- End the old account for reuse&lt;br/&gt;      end_account_for_file_reuse(oldAccountKey);&lt;br/&gt;      &lt;br/&gt;      -- create a new account using the appoitnment date and end of time keys&lt;br/&gt;      create_account_with_dates(fileNumber, firstName, lastName, appointmentDateKey, EndOfTimeDateKey);&lt;br/&gt;      &lt;br/&gt;      -- Get the new key&lt;br/&gt;      select account_id into account_key from account&lt;br/&gt;      where file_number = fileNumber&lt;br/&gt;        and upper(trim(last_name)) = upper(trim(lastName))&lt;br/&gt;        and upper(trim(first_name)) = upper(trim(firstName))&lt;br/&gt;        and appointmentDateKey between start_date_key and end_date_key;&lt;br/&gt;    &lt;br/&gt;    else&lt;br/&gt;    &lt;br/&gt;      -- No account exists using this file number; create a new account using the appoitnment date and end of time keys&lt;br/&gt;      create_account_with_dates(fileNumber, firstName, lastName, appointmentDateKey, EndOfTimeDateKey);&lt;br/&gt;      &lt;br/&gt;    end if;&lt;br/&gt;    &lt;br/&gt;    return account_key;&lt;br/&gt;&lt;br/&gt;end get_account_key;</source>
</FunctionOracle>